<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M8P | Agent Command Console</title>
    <script src="https://m8-site.desktop.farm/assets/moment.js"></script>
    <script src="https://m8-site.desktop.farm/assets/underscore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        m8: {
                            bg: '#050505',
                            surface: '#0A0A0C',
                            border: '#1F1F23',
                            primary: '#FF4D00', // Institutional Orange
                            dim: '#71717A',
                            text: '#E4E4E7'
                        }
                    }
                }
            }
        }
// tailwind.config = {
//     theme: {
//         extend: {
//             fontFamily: {
//                 sans: ['Inter', 'sans-serif'],
//                 mono: ['JetBrains Mono', 'monospace'],
//             },
//             colors: {
//                 m8: {
//                     // --- DARK MODE (Default/Current) ---
//                     bg: '#050505',
//                     surface: '#0A0A0C',
//                     border: '#1F1F23',
//                     primary: '#FF4D00', // Institutional Orange
//                     dim: '#71717A',
//                     text: '#E4E4E7',

//                     // --- LIGHT MODE (New Support) ---
//                     light: {
//                         bg: '#FFFFFF',        // Pure White
//                         surface: '#F8FAFC',   // Very subtle off-white (Slate-50)
//                         border: '#E2E8F0',    // Light Grey Border (Slate-200)
//                         primary: '#FF4D00',   // Keep the same Orange branding
//                         dim: '#64748B',       // Slate-500
//                         text: '#0F172A'       // Deep Slate/Black for text
//                     }
//                 }
//             }
//         }
//     }
// }
    </script>

    <style>
        body { background-color: #050505; color: #E4E4E7; }
        .grid-bg {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(31, 31, 35, 0.4) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(31, 31, 35, 0.4) 1px, transparent 1px);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0A0A0C; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF4D00; }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        /* Cursor for streaming effect */
        .typing-cursor::after {
            content: '▋';
            display: inline-block;
            vertical-align: bottom;
            animation: blinker 1s infinite;
            color: #FF4D00;
            margin-left: 2px;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden grid-bg selection:bg-m8-primary selection:text-white">

    <!-- Header -->
    <header class="h-14 border-b border-m8-border bg-[#050505]/95 backdrop-blur flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <!-- <div class="w-6 h-6 bg-m8-primary flex items-center justify-center text-black font-bold font-mono text-xs">M8</div> -->
            <img src="https://m8-site.desktop.farm/assets/odoo.webp" width="25px" />
            <span class="font-mono text-sm tracking-wide text-m8-dim">ODOO EDGE AGENT <span class="text-m8-primary">v1.0</span></span>
        </div>
        <div class="flex items-center gap-4 text-[10px] font-mono">
            <div class="flex items-center gap-2 text-m8-dim">
                <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(0,255,0,0.5)]"></span>
                SYSTEM ONLINE
            </div>
            <div class="px-2 py-1 bg-m8-border rounded text-white" id="latency-meter">
                LAST OP: -- ms
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Panel: Chat Interface -->
        <div class="flex-1 flex flex-col border-r border-m8-border min-w-[300px]">
            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
                <!-- Welcome Message -->
                <div class="flex gap-4 w-100">
                    <!--
                    <div class="w-8 h-8 rounded-sm bg-m8-surface border border-m8-border flex items-center justify-center shrink-0 text-m8-primary text-xs font-mono">M8</div>
                    <div>
                        <div class="text-xs font-mono text-m8-dim mb-1">SYSTEM</div>
                        <div class="text-sm leading-relaxed text-gray-300">
                            M8P Agent initialized. Session attached. Ready for instructions.
                        </div>
                    </div>
                    -->
                    <div id="ai-suggestion" style="width:100%"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-m8-surface border-t border-m8-border">
                <div class="relative">
                    <textarea id="chat-input" rows="1" 
                        class="w-full bg-[#050505] border border-m8-border p-4 pr-12 text-sm focus:outline-none focus:border-m8-primary transition-colors font-mono resize-none text-white placeholder-gray-600"
                        placeholder="Execute command or query..."></textarea>
                    <button id="send-btn" onclick="sendChat()" 
                        class="absolute right-2 bottom-2 p-2 text-m8-dim hover:text-m8-primary transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="flex justify-between items-center mt-2 px-1">
                    <div class="text-[10px] font-mono text-m8-dim">ENTER to send • SHIFT+ENTER for newline</div>
                    <button onclick="resetSession()" class="text-[10px] font-mono text-red-500 hover:text-red-400 uppercase tracking-wider">
                        <i class="fas fa-trash-alt mr-1"></i> Purge Memory
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Memory & Indexing -->
        <div class="w-[400px] flex flex-col bg-m8-surface border-l border-m8-border shrink-0">
            <!-- Tabs -->
            <div class="flex border-b border-m8-border">
                <button class="flex-1 py-3 text-xs font-mono font-bold text-m8-primary border-b-2 border-m8-primary bg-[#050505]">TOOLS STORE</button>
                <button class="flex-1 py-3 text-xs font-mono text-m8-dim hover:text-white transition-colors">LOGS</button>
            </div>

            <!-- Vector Store Controls -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- Indexing Section -->
                <div>
                    <h3 class="text-xs font-mono text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-database text-m8-dim"></i> Index Tool
                    </h3>
                    <div class="space-y-3">
                        <textarea id="index-content" rows="4" 
                            class="w-full bg-[#050505] border border-m8-border p-3 text-xs font-mono focus:border-m8-primary focus:outline-none text-gray-300"
                            placeholder="Enter text to embed into vector memory..."></textarea>
                        <textarea id="index-search-mask" rows="2" 
                            class="w-full bg-[#050505] border border-m8-border p-3 text-xs font-mono focus:border-m8-primary focus:outline-none text-gray-300"
                            placeholder="Enter result to be returned on match."></textarea>

                        <button onclick="indexContent()" 
                            class="w-full bg-m8-border hover:bg-m8-primary hover:text-black text-white text-xs font-mono py-2 transition-all border border-m8-border">
                            INDEX
                        </button>
                    </div>
                </div>

                <!-- Semantic Search Section -->
                <div class="pt-6 border-t border-m8-border">
                    <h3 class="text-xs font-mono text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-search text-m8-dim"></i> Memory Debug
                    </h3>
                    <div class="flex gap-2 mb-4">
                        <input id="search-query" type="text" 
                            class="flex-1 bg-[#050505] border border-m8-border p-2 text-xs font-mono focus:border-m8-primary focus:outline-none text-white"
                            placeholder="Search vector space...">
                        <button onclick="searchMemory()" 
                            class="px-4 bg-m8-border hover:bg-white hover:text-black text-white text-xs font-mono transition-colors">
                            FIND
                        </button>
                    </div>
                    
                    <!-- Results Area -->
                    <div id="search-results" class="space-y-2">
                        <div class="text-[10px] text-m8-dim font-mono text-center py-4 italic">No active search results</div>
                    </div>
                </div>
            </div>

            <!-- Telemetry Footer -->
            <div class="p-4 border-t border-m8-border bg-[#050505]">
                <div class="text-[10px] font-mono text-m8-dim mb-2 uppercase">Runtime Metrics</div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-m8-surface border border-m8-border p-2">
                        <div class="text-[10px] text-m8-dim">Latency</div>
                        <div id="stat-latency" class="text-lg font-bold text-m8-primary">0ms</div>
                    </div>
                    <div class="bg-m8-surface border border-m8-border p-2">
                        <div class="text-[10px] text-m8-dim">Status</div>
                        <div id="stat-status" class="text-xs font-bold text-green-500 mt-1">IDLE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const API_URL = ""; 
        const suggestions = [
            {
                title: "Leads e Oportunidades",
                category: "data",
                description: "Analise das leads e das oportunidades",
                command: "leads e oportunidades",
                sugs:[
                    {prompt:"Analise das leads e das oportunidades"},
                    {prompt:"Busque quantos leads/oportunidades temos."},
                    {prompt:"Cria um novo lead com nome 'Cliente Mario Silva'."},
                ],
            },
            {
                title: "CRM",
                category: "system",
                description: "Modulo de CRM (Gestao de Cliente)",
                command: "execute_odoo_command[diagnostics]",
                sugs:[
                    {prompt:"Crie um novo lead no CRM."},
                    {prompt:"Quais modelos relacionados ao CRM estão disponíveis?"},
                ],
            },
            {
                title: "Inventario & Vendas",
                category: "data",
                description: "Sistema de Invetario",
                command: "inventario | produtos | precario",
                sugs:[
                    {prompt:"Ordem de venda"},
                    {prompt:"Pesquise todos os produtos que são armazenáveis "},
                    {prompt:"Lista de preco dos produtos"},
                ],
            },
            {
                title: "Inspecao de Objectos",
                category: "ai",
                description: "Inspecao de Objectos",
                command: "message_notify_user[websocket]",
                sugs:[
                    {prompt:"Mostra-me os campos do modelo de leads."},
                ],
            },
            {
                title: "Notificacao",
                category: "ai",
                description: "Notificacao de Utilizadores",
                command: "message_notify_user[websocket]",
                sugs:[
                    {prompt:"notifica o utilizador alex"},
                ],
            },
        ];

        window.callPrompt = async function (P) {
            console.info("P: ", P);
            const input = document.getElementById('chat-input');
            input.value = P.text;

            const history = document.getElementById('chat-history');
            history.scrollTop = history.scrollHeight;

            await sendChat();
        }

        setTimeout(()=>{
            document.getElementById('ai-suggestion').innerHTML = renderPromptCards(suggestions);
        }, 340);

        function renderPromptCards(prompts) {
            if (!prompts || !Array.isArray(prompts) || prompts.length === 0) {
                return '';
            }

            // 1. Template Helper for Icons/Categories
            const getCategoryBadge = (cat) => {
                const catMap = {
                    'system':  { color: '#ef4444', label: 'SYS_OP' }, // Red
                    'data':    { color: '#3b82f6', label: 'DATA_IO' }, // Blue
                    'network': { color: '#10b981', label: 'NET_SEC' }, // Green
                    'ai':      { color: '#a855f7', label: 'AI_MOD' }  // Purple
                };
                const style = catMap[cat] || { color: '#ff5722', label: 'CMD' }; // Default Orange
                
                return `<span style="color: ${style.color}; border: 1px solid ${style.color}44; 
                        background: ${style.color}11; padding: 2px 6px; font-size: 10px;">[${style.label}]</span>`;
            };

            // 2. The Template
            const templateStr = `
            <div style="
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
                background-color: #0d0d0d; 
                padding: 20px;
                color: #e0e0e0;
            ">
                <div style="
                    border-bottom: 1px solid #333;
                    margin-bottom: 20px;
                    padding-bottom: 5px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                ">
                    <span style="color: #ff5722; font-size: 12px; letter-spacing: 1px;">
                        BEM VINDO AO ODOO EDGE AGENT
                    </span>
                    <span style="color: #fff; font-size: 12px; letter-spacing: 1px;">
                        Powered By AI Assembly & M8 | v0.0.4
                    </span>
                </div>

                <div style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                    gap: 15px;
                ">
                    <% _.each(items, function(item) { %>
                        <div style="
                                background-color: #111;
                                border: 1px solid #333;
                                padding: 15px;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                display: flex;
                                flex-direction: column;
                                justify-content: space-between;
                                min-height: 100px;
                            "
                        >
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <%= badge(item.category) %>
                                    <span style="color: #444; font-size: 10px;"></span>
                                </div>
                                <div style="
                                    color: #fff; 
                                    font-weight: bold; 
                                    font-size: 14px; 
                                    margin-bottom: 4px;
                                ">
                                    <%= item.title %>
                                </div>
                                <div style="color: #888; font-size: 12px; line-height: 1.4;">
                                    <%= item.description %>
                                </div>
                            </div>

                            <% _.each(item.sugs, function(S) { %>
                                <div style="
                                    margin-top: 5px;
                                    padding-top: 7px;
                                    border-top: 1px dashed #222;
                                    font-size: 10px;
                                    color: #555;"
                                    onclick="window.callPrompt({ type: 'insert_prompt', text: '<%= S.prompt %>' }, '*')"
                                    onmouseover="this.style.borderColor='#ff5722'; this.style.background='#161616';"
                                    onmouseout="this.style.borderColor='#333'; this.style.background='#111';">
                                    > <%= S.prompt %>
                                </div>
                            <% }) %>
                        </div>
                    <% }); %>
                </div>
            </div>
            `;

            // 3. Compile
            if (typeof _ === 'undefined') return "Error: Underscore.js missing";

            const compiled = _.template(templateStr);
            return compiled({ 
                items: prompts,
                badge: getCategoryBadge
            });
        }



        function renderTerminalTable(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return '<div style="font-family: monospace; color: #666; padding: 10px;">> NO_DATA_FOUND</div>';
            }

            // 1. Extract Headers
            const headers = Object.keys(data[0]);

            // 2. Formatter Logic (Adapted for Dark Theme)
            const formatValue = (key, value) => {
                if (value === null || value === undefined) return '<span style="color: #444;">null</span>';

                // Booleans: Terminal style [YES] / [NO]
                if (typeof value === 'boolean') {
                    const color = value ? '#00ff41' : '#ff3333'; // Neon Green / Red
                    return `<span style="color:${color}; font-weight:bold;">[${value ? 'TRUE' : 'FALSE'}]</span>`;
                }

                // Arrays (M2O or Lists)
                if (Array.isArray(value)) {
                    if (value.length === 2 && typeof value[0] === 'number') {
                        // Link style for Odoo relations
                        return `<span style="color: #ff9f43; text-decoration: underline; cursor: pointer;">${value[1]}</span>`;
                    }
                    return `[${value.join(', ')}]`;
                }

                // Currency / Numbers
                if (typeof value === 'number') {
                    const lowerKey = key.toLowerCase();
                    // Check for money fields
                    if (lowerKey.includes('price') || lowerKey.includes('amount') || lowerKey.includes('total')) {
                        return `<span style="color: #2ecc71;">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value)}</span>`;
                    }
                    // Standard numbers
                    return `<span style="color: #3498db;">${value}</span>`;
                }

                return String(value);
            };

            // 3. The "M8P" Terminal Template
            const templateStr = `
            <div style="
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
                background-color: #0d0d0d; 
                border: 1px solid #333; 
                color: #e0e0e0;
                font-size: 13px;
                margin-top: 10px;
            ">
                <div style="
                    background-color: #1a1a1a; 
                    padding: 4px 8px; 
                    border-bottom: 1px solid #333;
                    color: #ff5722; 
                    font-size: 11px;
                    letter-spacing: 1px;
                ">
                    >> DATA_OUTPUT_STREAM [${data.length}]
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #ff5722;"> <% _.each(headers, function(header) { %>
                                    <th style="
                                        text-align: left; 
                                        padding: 8px 12px; 
                                        color: #ff5722; /* Orange Headers */
                                        text-transform: uppercase; 
                                        font-weight: normal;
                                        border-right: 1px solid #222;
                                    ">
                                        <%= header %>
                                    </th>
                                <% }); %>
                            </tr>
                        </thead>
                        <tbody>
                            <% _.each(items, function(row, index) { %>
                                <tr style="border-bottom: 1px solid #222;">
                                    <% _.each(headers, function(key) { %>
                                        <td style="
                                            padding: 8px 12px; 
                                            border-right: 1px solid #222;
                                            color: #ccc;
                                        ">
                                            <%= formatter(key, row[key]) %>
                                        </td>
                                    <% }); %>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                <div style="padding: 4px 8px; font-size: 10px; color: #555; text-align: right;">
                    END_OF_STREAM // ${(new Date()).toISOString()}
                </div>
            </div>
            `;

            // 4. Compile
            if (typeof _ === 'undefined') return "Error: Underscore.js missing";
            
            const compiled = _.template(templateStr);
            return compiled({ 
                items: data, 
                headers: headers, 
                formatter: formatValue 
            });
        }

        function RenderHTML(host, staticHTML) {
          // const host = document.getElementById(idParent);
          if (host) {        
            if (host.shadowRoot) {
              const shadow = host.shadowRoot;
              shadow.innerHTML = staticHTML;                
            } else {
              const shadow = host.attachShadow({ mode: 'open' });
              shadow.innerHTML = staticHTML;                
            }
          }
        }

        // --- Utility Functions ---
        function formatLatency(tms) {
            if (!tms) return "--";
            
            // Format: " 42 [µs], 42466 [ns]" -> extract "42" before [µs]
            // Or just simple numbers if that's what comes back
            let microseconds = 0;
            
            const microMatch = tms.match(/([\d\.]+)\s*\[µs\]/);
            if (microMatch) {
                microseconds = parseFloat(microMatch[1]);
            } else {
                // Fallback for simple number strings
                const cleanTms = tms.replace(/[^0-9.]/g, ''); 
                microseconds = parseFloat(cleanTms);
            }

            if (!isNaN(microseconds)) {
                if (microseconds >= 1000) {
                    return (microseconds / 1000).toFixed(2) + " ms";
                } else {
                    return microseconds.toFixed(0) + " µs";
                }
            }
            return "--";
        }

        function updateTelemetry(tms) {
            const displayTime = formatLatency(tms);
            document.getElementById('latency-meter').innerText = `OP: ${displayTime}`;
            document.getElementById('stat-latency').innerText = displayTime;
            
            const el = document.getElementById('stat-latency');
            el.classList.add('text-white');
            setTimeout(() => el.classList.remove('text-white'), 200);
        }

        function createMessageBubble(role) {
            const history = document.getElementById('chat-history');
            const isUser = role === 'USER';
            
            const div = document.createElement('div');
            div.className = "flex gap-4 max-w-3xl " + (isUser ? "flex-row-reverse ml-auto" : "");
            
            let avatar = isUser 
                ? `<div class="w-8 h-8 rounded-sm bg-white/10 border border-white/20 flex items-center justify-center shrink-0 text-white text-xs"><i class="fas fa-user"></i></div>`
                : `<div class="w-8 h-8 rounded-sm bg-m8-surface border border-m8-border flex items-center justify-center shrink-0 text-m8-primary text-xs font-mono">M8</div>`;

            let canva_html = `
                <div class="canva-work" style="margin:0px">
                    <div class="canva-header">
                    </div>
                    <div class="canva-one1">
                    </div>
                    <div class="canva-two2">
                    </div>
                    <div class="canva-three2">
                    </div>
                    <div class="canva-error">
                    </div>
                    <div class="canva-body">
                    </div>
                </div>
            `

            // RenderHTML(temp0, "<h3>Hey there</h3>")

            div.innerHTML = `
                ${avatar}
                <div class="${isUser ? 'text-right' : 'flex-1'}">
                    <div class="text-xs font-mono text-m8-dim mb-1 flex items-center ${isUser ? 'justify-end' : ''}">
                        ${role}
                    </div>
                    ${role=='M8P' ? canva_html : ''} 
                    <div class="text-sm leading-relaxed ${isUser ? 'text-white' : 'text-gray-300'} whitespace-pre-wrap message-content"></div>
                </div>
            `;
            
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            // var canva = div.querySelector('.canva-work');
            // if (canva) {
            //     console.info("canva: ", canva);
            // }
            // return div.querySelector('.message-content');
            return div;
        }

        // --- API Interactions ---
        let toolMap = {}
        let tool_id = '';
        let is_running = false;

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || is_running) return;

            // User Message
            const userBubble = createMessageBubble('USER')
            const userContent = userBubble.querySelector('.message-content');
            userContent.textContent = text;
            input.value = '';
            
            document.getElementById('stat-status').innerText = "STREAMING...";

            // M8 Response Placeholder
            const m8Bubble = createMessageBubble('M8P');
            const m8Content = m8Bubble.querySelector('.message-content');;
            m8Content.classList.add('typing-cursor');
            
            let finalTms = null;
            is_running = true;

            try {
                // const response = await fetch(`${API_URL}/stream_chat`, {
                const response = await fetch(`${API_URL}/stream_odoo_v2`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: text })
                });

                if (!response.ok) throw new Error('Network error');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let startTime = performance.now();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    // Accumulate chunks
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Split by lines (SSE format)
                    const lines = buffer.split('\n');
                    // Keep the incomplete part for the next chunk
                    buffer = lines.pop(); 
                    // var tool_id='';

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine || !trimmedLine.startsWith('data: ')) continue;

                        try {
                            const jsonStr = trimmedLine.substring(6); // Remove 'data: '
                            const data = JSON.parse(jsonStr);
                            // console.info("jsonStr: ", jsonStr);

                            if (data.event || data.content) {
                                // Clean up the event text if it's double-quoted
                                let content = data.event || data.content;
                                if (typeof content === 'string') {
                                    if (content.startsWith('"') && content.endsWith('"') && content.length > 1) {
                                        content = content.slice(1, -1);
                                    }
                                    // Handle encoded newlines
                                    content = content.replace(/\\n/g, '\n');
                                }

                                // '<div class="canva-work">
                                //     <div class="canva-header">
                                //     </div>
                                //     <div class="canva-body">
                                //     </div>
                                // <div class="canva-one1">
                                // </div>
                                // <div class="canva-two2">
                                // </div>
                                // <div class="canva-three2">
                                // </div>
                                // <div class="canva-error">
                                // </div>

                                if ( content.indexOf('tool-execute')>=0 ) {
                                    console.info("[tool-start] content: ", content);
                                    var canva = m8Bubble.querySelector('.canva-work');
                                    var body = canva.querySelector('.canva-one1');
                                    RenderHTML(body, `<h3> ${content.replace('tool-execute','')} </h3>`);

                                } else if ( content.indexOf('tool-result')>=0 ) {
                                    console.info("[tool-executes] content: ", content)
                                    var canva = m8Bubble.querySelector('.canva-work');
                                    var body = canva.querySelector('.canva-two2');
                                    // console.info("body: ", body)
                                    var burrentBuffer = body.innerHTML
                                    var toolResult = content.replace('tool-result','');
                                    try {
                                        var json=JSON.parse(toolResult);
                                        // console.info('toolResult: ', toolResult);
                                        // var html = renderProductTable(json);
                                        // var html = renderDynamicTable(json);
                                        var html = renderTerminalTable(json);
                                        var snif = `<p class="text-muted" style="margin:0px;font-size:xx-small;color:#666;margin-bottom:4px;margin-top:4px;">Output ${toolResult}</p>`
                                        RenderHTML(body, burrentBuffer + html + snif);  
                                    } catch (e) {
                                        console.error("E: ", e);
                                        RenderHTML(body, burrentBuffer + toolResult);  
                                    }
                                    // RenderHTML(body, `<h3>  ${content}  </h3>`);

                                } else if ( content.indexOf('tool-finish')>=0 ) {
                                    console.info("[tool-finish] content: ", content)
                                    var canva = m8Bubble.querySelector('.canva-work');
                                    var body = canva.querySelector('.canva-three2');
                                    var burrentBuffer = body.innerHTML;
                                    var toolSignature = content.replace('tool-finish','');
                                    RenderHTML(body, burrentBuffer + toolSignature);

                                    m8Content.textContent += "Done.";

                                } else if ( content.indexOf('tool-error')>=0 ) {
                                    console.info("[tool-error] content: ", content)
                                    var canva = m8Bubble.querySelector('.canva-work');
                                    var burrentBuffer = body.innerHTML
                                    var body = canva.querySelector('.canva-error');
                                    RenderHTML(body, burrentBuffer + content.replace('tool-error',''));

                                } else {
                                    m8Content.textContent += content;                                    
                                }

                                const history = document.getElementById('chat-history');
                                history.scrollTop = history.scrollHeight;

                            } else if (data.delta) {
                                var d=data.delta;
                                if (d.content) {
                                    m8Content.textContent += content;
                                }

                                const history = document.getElementById('chat-history');
                                history.scrollTop = history.scrollHeight;

                            } else if (data.choices) {
                                data.choices.forEach((X) => {
                                    if (X.text&&X.text=="") return;
                                    if (X.text) {
                                        m8Content.textContent += X.text;
                                    } else if (X.delta && X.delta.content) {
                                        m8Content.textContent += X.delta.content;

                                    } else if(X.delta && X.delta.tool_calls) {
                                        X.delta.tool_calls.forEach((T) => {
                                            if (T.id && !toolMap[T.id]) {
                                                toolMap[T.id] = T.function;
                                                tool_id = T.id;
                                                m8Content.textContent += "Tool: "+T.function.name+" ";

                                            } else if(T.function.arguments) {
                                                toolMap[tool_id].arguments += T.function.arguments ;
                                                m8Content.textContent += T.function.arguments
                                            }
                                        });

                                    } else if (X.finish_reason && X.finish_reason=='tool_calls') {
                                        console.info('tool_calls: ', tool_id, toolMap);
                                        // var tool_to_execute = tool_calls[tool_id];
                                        // tool_to_execute.status = 'EXECUTING';
                                        tool_id = null;

                                    } else {
                                        console.info("TOOL: ", X);
                                    }

                                    setTimeout(()=>{
                                        const history = document.getElementById('chat-history');
                                        history.scrollTop = history.scrollHeight;
                                    }, 50);
                                });
                            }

                            // Check for final status payload
                            if (data.Status === 'OK' && data.Tms) {
                                finalTms = data.Tms;
                                updateTelemetry(data.Tms);
                            }

                        } catch (e) {
                            console.warn("JSON Parse error on line:", trimmedLine, e);
                        }
                    }
                    
                    // Simulated visual latency update during stream
                    let elapsed = (performance.now() - startTime).toFixed(0);
                    // document.getElementById('stat-latency').innerText = elapsed + " ms";
                }
                
            } catch (e) {
                m8Content.textContent += '\n[Connection Error: ' + e.message + ']';
                m8Content.classList.add('text-red-500');
                is_running = false;

            } finally {
                m8Content.classList.remove('typing-cursor');
                is_running = false;
                
                // Append latency badge if available
                if (finalTms) {
                    const latencyText = formatLatency(finalTms);
                    const latencyBadge = document.createElement('span');
                    latencyBadge.className = 'inline-block ml-2 text-[10px] font-mono text-m8-primary bg-m8-primary/10 px-1 rounded align-middle cursor-help';
                    latencyBadge.innerText = latencyText;
                    latencyBadge.title = "Execution Latency";
                    m8Content.appendChild(latencyBadge);
                }

                document.getElementById('stat-status').innerText = "IDLE";
            }
        }

        async function indexContent() {
            const input = document.getElementById('index-content');
            const input_mask = document.getElementById('index-search-mask');
            const text = input.value.trim();
            var input_mask_text = input_mask.value.trim()
            if (!text) return;

            if (!input_mask_text) {
                input_mask_text = text;
            }

            document.getElementById('stat-status').innerText = "INDEXING...";
            try {
                const res = await fetch(`${API_URL}/odoo-tool-index`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        content: text ,
                        mask: input_mask_text,
                    })
                });
                const data = await res.json();
                updateTelemetry(data.telemetry);
                input.value = '';
                
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = `
                    <div class="bg-green-900/20 border border-green-500/30 p-2">
                        <div class="text-[10px] text-green-500 font-mono">SUCCESSFULLY INDEXED</div>
                        <div class="text-xs text-white truncate">${text}</div>
                    </div>
                ` + resultsContainer.innerHTML;
            } catch (e) {
                alert('Indexing failed');
            }
            document.getElementById('stat-status').innerText = "IDLE";
        }

        async function searchMemory() {
            const query = document.getElementById('search-query').value;
            if(!query) return;

            document.getElementById('stat-status').innerText = "SEARCHING...";
            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="text-center text-xs font-mono text-m8-dim animate-pulse">Scanning Vector Space...</div>';

            try {
                const res = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                updateTelemetry(data.telemetry);

                container.innerHTML = '';
                if (data.result && data.result.length > 0) {
                    data.result.forEach(item => {
                        const content = typeof item === 'object' ? JSON.stringify(item) : item;
                        container.innerHTML += `
                            <div class="bg-[#111] border border-m8-border p-3 hover:border-m8-primary transition-colors cursor-default group">
                                <div class="flex justify-between mb-1">
                                    <span class="text-[10px] font-mono text-m8-primary">MATCH</span>
                                    <span class="text-[10px] font-mono text-m8-dim group-hover:text-white">ID: ${Math.floor(Math.random()*1000)}</span>
                                </div>
                                <div class="text-xs text-gray-400 font-mono line-clamp-3">${content}</div>
                            </div>
                        `;
                    });
                } else {
                    container.innerHTML = '<div class="text-[10px] text-m8-dim font-mono text-center py-4">No matches found</div>';
                }
            } catch (e) {
                container.innerHTML = `<div class="text-xs text-red-500 font-mono">Error: ${e.message}</div>`;
            }
            document.getElementById('stat-status').innerText = "IDLE";
        }

        async function resetSession() {
            if(!confirm("Destroy Agent Memory Session?")) return;
            await fetch(`${API_URL}/reset`, { method: 'POST' });
            window.location.reload();
        }

        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat();
            }
        });
    </script>
</body>
</html>